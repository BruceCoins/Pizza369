[TOC]  


## 一、攻击背景  
美链（BEC）是基于以太坊的 ERC-20 代币，其智能合约中包含一个batchTransfer函数，用于批量向多个地址转账。该函数设计初衷是提高转账效率，但因未对整数运算进行溢出检查，被攻击者利用。
	
## 二、漏洞代码分析  
漏洞出现在 ``batchTransfer`` 函数的逻辑中，关键代码片段如下：   
源码：https://etherscan.io/address/0xc5d105e63711398af9bbff092d4b6769c82f793d#code  
```solidity
function batchTransfer(address[] _receivers, uint256 _value) public returns(bool){
	uint256 senderBalance = balances[msg.sender];
	require(_receivers.length > 0 && _receivers.length < 20);
	require(_value > 0 && senderBalance > _value * _receivers.length); 
	
	//漏洞点
	uint256 total = _value * _receivers.length;
	balances[msg.sender] = senderBalance - total;
	
	for(uint256 i = 0; i < _receivers.length; i++){
		balances[_receivers[i]] += _value;
		Transfer(msg.sender, _receivers[i], _value);
	}
	
	return true;
}
```	
	
## 三、漏洞核心	
``_value * _receivers.length`` 的计算未进行溢出检查，当 ``_value`` 和 ``_receivers.length`` 的乘积超过 ``uint256`` 的最大值 ``(2^256 - 1)``时， 会发生 **整数溢出** ，结果变为一个极小值，甚至是0。  
	
## 四、攻击过程  
攻击生成的交易：https://etherscan.io/tx/0xad89ff16fd1ebe3a0a7cf4ed282302c06626c1af33221ebe0d3a470aba4a660f  
<image src="https://github.com/BruceCoins/Pizza369/blob/main/0x0004%20safe/images/beauty%20_chain1.png"  width="=60%"> 
### 1、制造恶意参数：  
攻击者选择 ``_receivers.length = 2`` (接收地址为2个)，并设置 ``_value``为一个极大（如 2^255）。此时：``_value * 2 = 2^255 * 2 = 2^256``，而 ``uint256`` 最大值为 ``2^256 - 1`` ，一次计算结果溢出为 0 。  

### 2、绕过余额检查：  
函数中 ``require(senderBalance >= _value * _receivers.length)`` 的条件变为 ``senderBalance >= 0``，显然成立（攻击者只需持有少量 BEC 即可满足）。  
	
### 3、获取巨额代币：  
函数执行时，攻击者余额减少 ``total = 0`` （实际未减少），但循环向两个接收地址各转入 ``_value（2^255）`` 个 BEC，相当于无成本创造了巨额代币。  
	
### 4、市场冲击：  
攻击者通过交易所抛售大量非法获取的 BEC，导致代币价格暴跌，项目方被迫紧急暂停合约。  

## 五、漏洞本质与修复  
### 1、本质：  
未处理整数溢出，导致乘法运算结果异常，绕过了余额校验逻辑。  
	
### 2、修复方案：  
- 使用SafeMath库（或 Solidity 0.8.0 + 内置的溢出检查）对整数运算进行保护，确保计算结果不溢出。  
- 修复后代码：  
```solidity
// 使用SafeMath的mul函数进行乘法，自动检查溢出
require(_value.mul(_receivers.length) <= senderBalance);
uint256 total = _value.mul(_receivers.length);

```	


