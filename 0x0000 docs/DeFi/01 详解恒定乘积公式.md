## 恒定乘积公式（Constant Product Formula）详解  
恒定乘积公式（x · y = k）是自动做市商（AMM）的核心算法，最早由 Uniswap V1/V2 采用。它通过舒徐规则确保交易对流动性池中两种资产数量的乘积始终保持不变，从而自动计算交易价格并维持市场平衡。  

### 1、公式定义  
对于交易对，如 ETH / DAI ：
- x = ETH 数量
- y = DAI 数量
- k = 恒定乘积（常数）          
- p =  $$\frac{y}{x}$$ （每个 ETH 可兑换的 DAI 数量）    

公式表示为： **x · y = k**  
**核心规则：** 任何交易必须保证交易结束后的 $$x' \cdot y' = k$$   

### 2、交易价格计算  
- 当用户使用 $\Delta x$ 数量的 ETH 购买 $\Delta y$ 的数量 DAI 时，**新的池子**状态需满足(保持 k 不变)：
  $(x + \Delta x) \cdot (y - \Delta y) = k$

- 解出 $\Delta y$ （用户获得的 DAI 数量）：
  $\Delta y = y - \frac{k}{x + \Delta x}$

- 由于 $k = x \cdot y $，代入后得： $\Delta y = y - \frac{x \cdot y}{x + \Delta x} = \frac{y \cdot \Delta x}{x + \Delta x} $   

**实际价格：**  
用户用 $\Delta x$ 个 ETH 兑换 $\Delta y$ 个 DAI，实际成交价为：
价格 = $\frac{\Delta y}{\Delta x} = \frac{y}{x = \Delta x}$

### 3、关键特性  
#### （1）价格随交易量动态变化，k 保持不变  
- **买入 DAI （消耗 ETH）: $(x + \Delta x) \cdot (y - \Delta y) = k$**
  
  - x 增加（池中 ETH 变多） --> y 减少（DAI变少） --> **DAI价格上升**
  - 即：买的越多，单价越贵（滑点产生）
- **卖出 DAI (换取 ETH)： $(x - \Delta x) \cdot (y + \Delta y) = k$**  
  - x 减少（ETH变少） --> y 增加（DAI 变多） --> **DAI价格下降**
#### （2）无限流动性  

- 理论上，池子永远不会枯竭：
  当 $\Delta x \to \infty 时 \Delta  y \to y$，（用户最多能买光池子中所有的 DAI，但需要付出无限 ETH）。

#### （3）价格与市场联动  
- 外部市场价格变化时，套利者会动过交易使 AMM 价格与市场对齐
  例如：若 ETH 市价上涨，套利者会从 AMM 低价买入 ETH，直到 AMM 的 ETH 价格同步上涨

### 4、实例演算  
假设 ETH / DAI 池初始状态：
```
x = 10 ETH
y = 20,000 DAI
k = 10 x 20,000 = 200,000
p = y / x = 2000 (即每个 ETH 可以兑换 2000 DAI)
```
#### 情景1：用户用 1 ETH 购买 DAI   
- **投入 $\Delta x = 1 ETH， 求 \Delta y (获得的 DAI)$**：

  $(x + \Delta x)(y - \Delta y) = k$ 转换后得到：

  $\Delta y = \frac{y \cdot \Delta x}{x + \Delta x} = \frac{20,000 \times 1}{10 + 1} \approx 1818.18 DAI$

- **新池子状态：**


