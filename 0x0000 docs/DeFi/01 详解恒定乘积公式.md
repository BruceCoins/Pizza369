## 恒定乘积公式（Constant Product Formula）详解  
恒定乘积公式（x · y = k）是自动做市商（AMM）的核心算法，最早由 Uniswap V1/V2 采用。它通过舒徐规则确保交易对流动性池中两种资产数量的乘积始终保持不变，从而自动计算交易价格并维持市场平衡。  

### 1、公式定义  
对于交易对，如 ETH / DAI ：
- x = ETH 数量
- y = DAI 数量
- k = 恒定乘积（常数）          
- p =  $$\frac{y}{x}$$ （每个 ETH 可兑换的 DAI 数量）    

公式表示为： **x · y = k**  
**核心规则：** 任何交易必须保证交易结束后的 $$x' \cdot y' = k$$   

### 2、交易价格计算  
- 当用户使用 $\Delta x$ 数量的 ETH 购买 $\Delta y$ 的数量 DAI 时，**新的池子**状态需满足(保持 k 不变)：
  $(x + \Delta x) \cdot (y - \Delta y) = k$

- 解出 $\Delta y$ （用户获得的 DAI 数量）：
  $\Delta y = y - \frac{k}{x + \Delta x}$

- 由于 $k = x \cdot y $，代入后得： $\Delta y = y - \frac{x \cdot y}{x + \Delta x} = \frac{y \cdot \Delta x}{x + \Delta x} $   

**实际价格：**  
用户用 $\Delta x$ 个 ETH 兑换 $\Delta y$ 个 DAI，实际成交价为：
价格 = $\frac{\Delta y}{\Delta x} = \frac{y}{x = \Delta x}$

### 3、关键特性  
#### （1）价格随交易量动态变化，k 保持不变  
- **买入 DAI （消耗 ETH）: $(x + \Delta x) \cdot (y - \Delta y) = k$**
  
  - x 增加（池中 ETH 变多） --> y 减少（DAI变少） --> **DAI价格上升**
  - 即：买的越多，单价越贵（滑点产生）
- **卖出 DAI (换取 ETH)： $(x - \Delta x) \cdot (y + \Delta y) = k$**  
  - x 减少（ETH变少） --> y 增加（DAI 变多） --> **DAI价格下降**
#### （2）无限流动性  

- 理论上，池子永远不会枯竭：
  当 $\Delta x \to \infty 时 \Delta  y \to y$，（用户最多能买光池子中所有的 DAI，但需要付出无限 ETH）。

#### （3）价格与市场联动  
- 外部市场价格变化时，套利者会动过交易使 AMM 价格与市场对齐
  例如：若 ETH 市价上涨，套利者会从 AMM 低价买入 ETH，直到 AMM 的 ETH 价格同步上涨

### 4、实例演算  
假设 ETH / DAI 池初始状态：
```
x = 10 ETH
y = 20,000 DAI
k = 10 x 20,000 = 200,000
p = y / x = 2000 (即每个 ETH 可以兑换 2000 DAI)
```
#### 情景1：用户用 1 ETH 购买 DAI   
- **投入 $\Delta x = 1 ETH， 求 \Delta y (可以获得的 DAI)$**：

  $(x + \Delta x)(y - \Delta y) = k$ 转换后得到：

  $\Delta y = \frac{y \cdot \Delta x}{x + \Delta x} = \frac{20,000 \times 1}{10 + 1} \approx 1818.18 DAI$

- **新池子状态：**
  -  x' = 10 + 1 == 11 ETH
  -  y' = 20,000 - 1818.18 = 18,181.82 DAI
  -  检查： $11 \times 18,181.82 \approx 200,000$ (k不变)

- **实际价格：**
  $1 ETH /approx 1818.18 DAI$ (低于初始价 2000 DAI，因大额交易导致滑点)

#### 情景2：在情景1基础上 用户卖出 1818.18 DAI 给池子，兑换成 ETH  
- **$投入 \Delta y = 1818.18 DAI , 求 \Delta x (可以获得的 ETH)$**
  
     $(x - \Delta x)(y + \Delta y) = k$

  代入值得到：  

     $(11 - \Delta x)(18,181.82 + 1,818.18) = 200,000$  

  化简： 

     $(11 - \Delta x) \times 20,000 = 200,000$

  解的：

     $11 - \Delta x = 10 即 \Delta = 1 ETH$

- **新池子状态（恢复到原来状态）：**  
  - ETH = 11 - 1 = 10 
  - DAI = 18,181.82 + 1818.18 = 20,000
  - 验证： $10 \times 20,000 = 200,000 = k(正确)$ 

 ### 5、与无偿损失的关系    
 无偿损失的本质是 AMM 强制保持 $x \cdot y = k$ ，导致 LP 资产价值受价格波动影响：    
 - 当外部价格变化时，套利者调整池子比例，使 PL 的资产组合偏离单纯持有时的价值。
 - 公式推导：
   设价格变化为 $p = /frac{y}{x}$，则 LP 资产价值与单纯持有价值的比值 R 为：
   $R = \frac{2 \sqrt{p}}{1 + p}$

   当 $p \neq 1$ （价格变动）时，R < 1（即存在损失）。

### 6、代币存入流动性池子时 xy=k 变化分析   
$\Delta x：存入x数量 ， \Delta y：存入y数量$  
| 操作                | 是否改变 $k$？ | 原因                                                                 |  
|---------------------|---------------|----------------------------------------------------------------------|  
| 按比例存入 $(\Delta x, \Delta y)$ | **是**         | $k' = (x + \Delta x)(y + \Delta y) > k$，池子规模扩大。              |  
| 单边存入（如仅 $\Delta x$）      | **是**         | 系统自动兑换部分资产以维持比例，最终 $k$ 仍增加。                     |  
| 交易（如用 $\Delta x$ 换 $\Delta y$） | **否**         | $(x + \Delta x)(y - \Delta y) = k$，仅重新分配资产。                  |  



### 7、公式局限性  
- **大额交易滑点高：** 对流动性不足的池子，大额交易会导致价格剧烈波动
- **资本效率低：** 传统 AMM (如 Uniswap V2) 要求流动性均匀分布，资金利用率低，（ Uniswap V3 通过集中流动性改进）。  

