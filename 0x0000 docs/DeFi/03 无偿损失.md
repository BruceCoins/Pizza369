## 无偿损失  
### 1、定义  
无常损失是指流动性提供者（LP）因代币价格波动，在 ``AMM 池中资产``的价值**低于** ``单纯持有`` 资产时的损失。它是“无常”的，因为如果价格回归初始比例，损失会消失。   

代币价格发生变化后，计算流动性池中两种资产的新数量，需要根据 [**恒定乘积公式(x·y=k)**](https://github.com/BruceCoins/Pizza369/blob/main/0x0000%20docs/DeFi/01%20%E8%AF%A6%E8%A7%A3%E6%81%92%E5%AE%9A%E4%B9%98%E7%A7%AF%E5%85%AC%E5%BC%8F.md) 和 **价格比例变化（P = $\frac{y}{x}$）** 的数学关系。

-----------------
### 2、公式  
无偿损失的通用公式：&emsp;&emsp;&emsp;&emsp;  **无偿损失（IL）=** $\frac{2 \sqrt{\Delta}}{1 + \Delta} - 1$  

其中： $\Delta$ 是价格变化的倍数（例如：代币A 的价格从 P 变为 P· $\Delta$）  

**情景描述：**  
设初始池中代币分别为 x、y  
存在：``x·y = k``，价格兑换比例： $\frac{y}{x}$ = P， 现 x 价格上涨为原来的 r 倍（r > 1）   

根据恒定乘积公式，新得代币数量满足：  
- x' · y' = k (乘积不变)
- 新的价格兑换比例 $\frac{y'}{x'} = P' = r · \frac{y}{x}$

**解方程得到：**  $x' = \frac{x}{\sqrt{r}} = \sqrt{\frac{k}{P'}}$  &emsp;&emsp;&emsp;&emsp; $y' = \sqrt{r}·y = \sqrt{k · P'}$  

 

-----------------
### 3、举例说明  
假设一个 ETH / DAI （x/y）流动性池： 
- **初始池子：** 10 ETH + 10,000 DAI（总价值 20，000 DAI）
- **初始价格 P：** 1 ETH = 1000 DAI
- **此时 LP 投入**：1 ETH + 1000 DAI（总价值 2000 DAI，占池子的 10% ）  

根据恒定乘积公式：  
&emsp;&emsp;&emsp;&emsp; x · y = k = 100,000 &emsp;&emsp;&emsp;&emsp; $\frac{y}{x} = 1,000$         

#### ------- 情景1：外部市场 ETH 价格上涨50% （1 ETH = 1,500 DAI）-------  
**【1】套利者调整池子：从池子中买入 ETH 卖到外部市场套利**  
- 新价格 P' = 1,500 DAI / ETH
- 根据恒定乘积公式 x·y=k，池子调整到(x',y')，使得：
  - **新价格匹配市场：** $\frac{y'}{x'} = P‘ = 1,500$  
  - **恒定乘积不变：** x' · y' = k = 10,000  
  
  则公式代入后，池子中新的数量应调整为（r 为 x 上涨得倍数,r >1）：
  
  - ETH 数量 x' = $\sqrt{\frac{k}{P'}} = \sqrt{\frac{100,000}{15,00}} \approx 8.165 ETH$  

  - DAI 数量 y' = $\sqrt{k · P'} = \sqrt{100,000 \times 1,500} \approx 12,247.45 DAI$
 
**【2】LP提取资产：**  
- LP 占 10% ，可提取：
  - 0.8165 ETH (价值 0.8165 $\times$ 1,500 = 1,224.75 DAI)
  - 1,224.75 DAI
  - **总价值：** 1,224.75 + 1,224.75 = **2,449.5 DAI**
    
**【3】如果LP不提供流动性，而是持有：**
- 初始资产：1 ETH + 1,000 DAI
- 当前价值：1 ETH $\times$ 1,500 + 1000 = **2,500 DAI**

**【4】无偿损失：**   
- 2,449.5 - 2,500 = -50.5 DAI
- 损失比例： $\frac{50.5}{2,500} \times 100\\% \approx 2.02\\%$

**验证公式：**  
- $\Delta = 1.5 (价格上涨 50\\%)$
- IL = $\frac{2\sqrt{1.5}}{1 + 1.5} - 1 \approx 0.0202 (即 2.02\\%)$

#### ------- 情景2：外部市场 ETH 价格下跌 50% （1 ETH = 500 DAI）--------    
**【1】套利者调整池子：从池子中买入 DAI 买到外部市场套利**  
- 新价格 P' = 500 DAI / ETH  
- 根据恒定乘积公式 x·y=k，则池子调整到(x',y')，使得：  
  - **新价格匹配：** $\frac{y'}{x'} = 500$  
  - **恒定乘积不变：** x' · y' = 10,000
  
  公式代入后，池子中新的数量应调整为：  
    
  - ETH 数量 x' = $\sqrt{\frac{100,000}{500}} \approx 14.142 ETH$  
  - DAI 数量 y' = $\sqrt{100,000 \times 500} \approx 7,071.07 DAI$
  - 
**【2】LP提取资产：**
- LP 占 10% ，可提取：
  - 1.4142 ETH (价值 1.4142 $\times$ 500) = 707.11 DAI
  - 707.11 DAI
  - **总价值：** 707.11 + 707.11 = **1,414.22 DAI**

**【3】如果LP不提供流动性，而是持有：**  
- 初始资产：1 ETH + 1,000 DAI  
- 当前价值：1 $\times$ 500 + 1,000 = **1500 DAI**

**【4】无偿损失**
- 1414.22 - 1500 = -85.78
- 损失比例： $\frac{85.78}{1500} \times 100\\% \approx 0.0572(即 5.72\\%)$   

**验证公式：**  
- $\Delta = 0.5 (价格下跌 50\\%)$
- IL = $\frac{2\sqrt{0.5}}{1+0.5}-1 \approx 0.0572(即 5.72\\%)$

### 为什么不进行线性调整


